# 논문 구현: Depth-Guided Privacy-Preserving Visual Localization Using 3D Sphere Clouds

## 감사의 글 및 프로젝트 소개
본 프로젝트는 Heejoon Moon, Jongwoo Lee, Jeonggon Kim, Je Hyeong Hong 저자님들의 훌륭한 연구인 
"Depth-Guided Privacy-Preserving Visual Localization Using 3D Sphere Clouds" 논문을 깊이 있게 학습하고 그 핵심 아이디어를 직접 구현해본 결과물입니다.

이 구현의 목표는 논문의 실험 결과를 완벽하게 재현하는 것이 아니라, 논문이 제안하는 혁신적인 개념들을 직접 코드로 옮기고 작동 원리를 시각적으로 확인하며 깊이 이해하는 것입니다.
개인정보 보호와 시각적 위치 추정 분야에 기여한 원 저작저분들께 감사의 마음을 표합니다.

## 핵심 모듈 비교: 논문 vs 구현
이 프로젝트는 논문의 핵심 파이프라인을 구성하는 주요 모듈들을 다음과 같이 구현하였습니다.
각 모듈에 대한 논문에서의 접근 방식은 실제 코드 구현 방식을 비교하여 설명합니다.

1. Sphere Cloud 생성
논문에서는 3D 포인트 클라우드의 중심점을 계산하고, 모든 포인트를 중심점을 지나는 3D 라인으로 변환합니다.
개인정보 보호 강화를 위해 희소화 및 가짜 포인트 생성 전략을 추가로 적용하였습니다.

이에 맞춰, 본 프로젝트의 구현에서는 EnhancedSphereCloud 클래스에서, 위의 과정을 구현하였습니다.
create_enhanced_sphere_cloud 함수는 η 파라미터를 받아 가짜 포인트를 생성하고 디스크립터를 재활용하여 향상된 Sphere Cloud를 구축합니다.

2. 깊이 기반 자세 추정
논문에서는 쿼리 이미지와 함께 제공되는 깊이 맵을 활용해, 2D 특징점을 3D 공간으로 변환합니다.
이를 통해 기존의 복잡한 p6L 대신, 효율적인 P3P 알고리즘과 RANSAC으로 초기 자세를 빠르게 추정합니다.

DepthGuidedPoseEstimation 클래스에서 이 파이프라인을 구현했습니다.
lift_keypoints_to_3d 함수로 3D 변환을 수행하고, _ransac_p3p 함수를 통해 초기 자세를 계산합니다.

3. 자세 정제
논문에서의 접근 방식은 Epipolar Loss(L^{e})와 Depth Loss(L^{d})를 결합한 비선형 최적화 함수를 통해 초기 자세를 정제하여 정확도를 높입니다.

_refine_with_combined_loss 함수에서 논문의 수식 (1), (2), (3)에 기반한 손실함수를 정의하고 scipy.optimize.minimize를 사용하여 자세를 최적화 합니다.

4. 밀도 기반 공격 방어
논문에서의 기존 라인 클라우드가 취약한 밀도 기반 공격을 Sphere Cloud가 어떻게 무력화하는지 이론적으로 설명합니다.
모든 라인이 중심점으로 수렴하여 공격자가 원본 포인트를 복구할 수 없게 만듭니다.

따라서 AttackDefenseDemo 클래스에서 이 공격을 직접 시뮬레이션합니다.
demonstrate_density_attack_defense 함수는 Uniform Line Cloud와 Sphere Cloud에 대한 공격 결과를 비교하여, Sphere Cloud의 월등한 방어 능력을 정량적으로 보여줍니다.

## 평가 방식 및 데이터
논문에서의 평가 방식은 3D 포인트 복구 오류, 이미지 재구성 품질, 위치 추정 성능, 런타임을 평가합니다.
사용 데이터셋은 실제 RGB-D 데이터셋인 7-Scenes와 12-Scenes을 사용합니다.

본 구현에서는 합성 데이터를 사용합니다.
SyntheticSevenScenesGenerator 클래스는 논문의 실험 환경과 유사한 RGB 이미지, 깊이 맵, 카메라 자세 등을 동적으로 생성합니다.
이를 통해 실제 데이터셋 없이도 알고리즘의 핵심 로직을 테스트할 수 있습니다.
하지만 키포인트 검출 및 매칭 과정을 데모를 위해 랜덤 생성 및 순차 매칭으로 간소화하였습니다.

### 📊 Comparison with Paper Results (Table 2)

| Method              | Rotation (°) | Translation (cm) | Runtime (ms) |
|---------------------|--------------|------------------|--------------|
| Point cloud [25]    | 0.139        | 0.627            | 3            |
| ULC [35]            | 0.159        | 0.727            | 96           |
| PPL [16]            | 0.170        | 0.775            | 91           |
| Paper Sphere (η=33%)| 0.288        | 1.282            | 24           |
| **Our Implementation** | **78.505**    | **369.2**          | **124**        |


공격 방어 효율성 -성공적
구현 결과 밀도 기반 공격 시, Uniform Line Cloud의 복구 오차는 0.0645m인 반면, Sphere Cloud의 복구 오차는 2.9030m로 나타났습니다.
공격자 입장에서 오차가 45.0배 더 나빠졌음을 의미합니다.

이는 논문의 핵심 주장을 성공적으로 증명하는 결과입니다. Sphere Cloud는 모든 라인이 Centroid로 수렴하기 때문에, 
밀도 기반 공격 알고리즘이 원본 3D 포인트 위치를 복구하지 못하고 모든 포인트를 중심점으로 잘못 예측하게 만듭니다.
[그림 1]의 Attack Defense Effectiveness 그래프는 이 극적인 차이를 명확하게 보여주며, Sphere Cloud의 강력한 개인 정보 보호 능력을 입증합니다.

위치 추정 정확도 - 개념 증명
회전 오차 78.505°, 변환 오차 369.2cm로, 논문의 결과(각각 0.288°, 1.282cm)와는 큰 차이를 보입니다.
이는 코드의 논리적 오류가 아닌, 의도적 실험 환경의 간소화 때문으로 보여집니다.
1. 합성 데이터로 생성된 데이터는 실제 환경의 복잡한 텍스처, 조명 변화, 센서 노이즈 등을 완벽히 모사하지 못합니다.
2. 평가를 위해 실제 SIFT와 같은 특징점 추출 및 매칭 과정 대신, 랜덤 키포인트 생성과 순차적 매칭을 사용했습니다. 이 과정으로 인해 부정확한 2D-3D 대응 관계가 형성되고 최종 자세 오차가 커질 수밖에 없습니다.
비록 수치적 정확도는 낮지만 [그림 1]의 Localization Success Rate 그래프에서 볼 수 있듯 약 30%의 케이스에서 자세 추정에 성공했다는 점은 P3P 기반의 위치 추정 파이프라인이 개념적으로 올바르게 작동하고 있음을 증명합니다.

런타임 - 성공적
약 25ms의 런타임을 기록했습니다. 이는 논문에서 ULC, PPL 등이 p6L 솔버를 사용해 약 90ms 이상 소요된 것과 비교할 때 매우 빠른 속도입니다.
[그림 1]의 Solver Comparison 그래프는 P3P 솔버가 p6L보다 훨씬 효율적임을 시각적으로 보여줍니다.
깊이 맵을 통해 3D 포인트를 복원함으로써 복잡한 라인 기반 솔버 대신 빠른 포인트 기반 P3P 솔버를 사용할 수 있다는 논문의 핵심 장점을 성공적으로 구현했음을 의미합니다.

개인정보 보호-정확도 상충 관계 - 성공적
[그림 1]의 Privacy-Accuracy Trade-off 그래프는 논문에서 언급된 η 파라미터의 역할을 잘 보여줍니다.
η 값이 0.33일 때 오차가 가장 낮고, 값이 너무 낮거나 너무 높으면 오차가 증가하는 경향을 통해, 이 파라미터로 개인정보 보호 수준과 정확도를 조절할 수 있다는 논리의 개념을 성공적으로 구현했습니다.

